---
import type { MarkdownHeading } from "astro";
import { widgetManager } from "@/utils/widget-manager";
import Announcement from "@/components/widget/Announcement.astro";
import Categories from "@/components/widget/Categories.astro";
import Profile from "@/components/content/Profile.astro";
import Tags from "@/components/widget/Tags.astro";
import TOC from "@/components/widget/TOC.astro";
import Advertisement from "@/components/widget/Advertisement.astro";

interface Props {
  class?: string;
  headings?: MarkdownHeading[];
}

const { class: className, headings } = Astro.props;

// 获取配置的组件列表
const topComponents = widgetManager.getComponentsByPosition("top");
const stickyComponents = widgetManager.getComponentsByPosition("sticky");

// 提取客户端需要的数据
const breakpoints = widgetManager.getBreakpoints();
const sidebarConfig = {
  breakpoints: breakpoints,
  shouldShowSidebar: {
    mobile: widgetManager.shouldShowSidebar("mobile"),
    tablet: widgetManager.shouldShowSidebar("tablet"),
    desktop: widgetManager.shouldShowSidebar("desktop"),
  },
};

// 组件映射表
const componentMap = {
  profile: Profile,
  announcement: Announcement,
  categories: Categories,
  tags: Tags,
  toc: TOC,
  advertisement: Advertisement,
};

// 渲染组件的辅助函数
function renderComponent(component: any, index: number, _components: any[]) {
  const ComponentToRender =
    componentMap[component.type as keyof typeof componentMap];
  if (!ComponentToRender) return null;

  const componentClass = widgetManager.getComponentClass(component, index);
  const componentStyle = widgetManager.getComponentStyle(component, index);

  return {
    Component: ComponentToRender,
    props: {
      class: componentClass,
      style: componentStyle,
      headings: component.type === "toc" ? headings : undefined,
      configId: component.configId, // 传递configId给Advertisement组件
      ...component.customProps,
    },
  };
}
---

<div id="sidebar" class:list={[className, "w-full", "relative"]}>
  <!-- 顶部固定组件区域 -->
  {
    topComponents.length > 0 && (
      <div class="flex flex-col w-full gap-4 mb-4">
        {topComponents.map((component, index) => {
          const renderData = renderComponent(component, index, topComponents);
          if (!renderData) return null;

          const { Component, props } = renderData;
          return <Component {...props} />;
        })}
      </div>
    )
  }

  <!-- 粘性组件区域 -->
  {
    stickyComponents.length > 0 && (
      <div
        id="sidebar-sticky"
        class="transition-all duration-700 flex flex-col w-full gap-4 top-4 sticky top-4"
      >
        {stickyComponents.map((component, index) => {
          const renderData = renderComponent(
            component,
            index,
            stickyComponents
          );
          if (!renderData) return null;

          const { Component, props } = renderData;
          return <Component {...props} />;
        })}
      </div>
    )
  }

  <!-- 底部装饰渐变 -->
  <div class="sidebar-bottom-gradient pointer-events-none"></div>
</div>

<!-- 响应式样式和JavaScript -->
<style>
  /* 响应式断点样式 */
  @media (max-width: 768px) {
    #sidebar {
      display: var(--sidebar-mobile-display, block);
    }
  }

  @media (min-width: 769px) and (max-width: 1024px) {
    #sidebar {
      display: var(--sidebar-tablet-display, block);
    }
  }

  @media (min-width: 1025px) {
    #sidebar {
      display: var(--sidebar-desktop-display, block);
    }
  }

  /* 侧边栏底部装饰渐变 */
  .sidebar-bottom-gradient {
    position: fixed;
    bottom: 0;
    left: 0;
    width: 17.5rem;
    height: 200px;
    background: linear-gradient(
      to top,
      rgba(var(--card-bg-rgb, 255, 255, 255), 0.3) 0%,
      rgba(var(--card-bg-rgb, 255, 255, 255), 0.15) 30%,
      transparent 100%
    );
    z-index: 1;
    transition: opacity 0.3s ease;
  }

  /* 暗色模式下的渐变 */
  :global(.dark) .sidebar-bottom-gradient {
    background: linear-gradient(
      to top,
      rgba(30, 30, 30, 0.4) 0%,
      rgba(30, 30, 30, 0.2) 30%,
      transparent 100%
    );
  }

  /* 移动端隐藏底部渐变 */
  @media (max-width: 768px) {
    .sidebar-bottom-gradient {
      display: none;
    }
  }

  /* 平板端调整宽度 */
  @media (min-width: 769px) and (max-width: 1024px) {
    .sidebar-bottom-gradient {
      width: 280px;
    }
  }

  /* 桌面端宽度 */
  @media (min-width: 1025px) {
    .sidebar-bottom-gradient {
      width: 320px;
    }
  }
</style>

<script define:vars={{ sidebarConfig }}>
  // 响应式布局管理
  class SidebarManager {
    constructor() {
      this.config = sidebarConfig;
      this.init();
    }

    init() {
      this.updateResponsiveDisplay();
      window.addEventListener("resize", () => this.updateResponsiveDisplay());

      // 监听SWUP内容替换事件
      if (typeof window !== "undefined" && window.swup) {
        window.swup.hooks.on("content:replace", () => {
          // 延迟执行以确保DOM已更新
          setTimeout(() => {
            this.updateResponsiveDisplay();
          }, 100);
        });
      }
    }

    updateResponsiveDisplay() {
      const breakpoints = this.config.breakpoints;
      const width = window.innerWidth;

      let deviceType;
      if (width < breakpoints.mobile) {
        deviceType = "mobile";
      } else if (width < breakpoints.tablet) {
        deviceType = "tablet";
      } else {
        deviceType = "desktop";
      }

      const shouldShow = this.config.shouldShowSidebar[deviceType];
      const sidebar = document.getElementById("sidebar");

      if (sidebar) {
        sidebar.style.setProperty(
          `--sidebar-${deviceType}-display`,
          shouldShow ? "block" : "none"
        );
      }
    }
  }

  // 初始化侧边栏管理器
  new SidebarManager();
</script>
